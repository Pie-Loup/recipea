<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Créer une recette depuis un texte</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.svg') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style_recipe_generator.css') }}">
  <script src="{{ url_for('static', filename='js/disable-zoom.js') }}"></script>
  <script src="{{ url_for('static', filename='js/theme-color.js') }}"></script>
</head>
<body>
  <div class="container">
    <h1>Créer une recette depuis un texte</h1>
    
    <div id="initial-input">
      <textarea id="prompt" placeholder="Décrivez la recette que vous souhaitez créer..."></textarea>
      <button id="generateBtn" class="main-btn" disabled>Générer la recette</button>
    </div>

    <div id="recipe" class="recipe-container"></div>

    <div id="update-input" class="hidden update-section">
      <textarea id="update-prompt" placeholder="Que voulez-vous modifier sur cette recette? Par exemple, je n'ai pas de concombre, ou je n'aime pas le fromage, je veux plus de sauce etc..."></textarea>
      <div class="button-group">
        <button id="updateBtn" class="main-btn" disabled>Modifier la recette</button>
        <button id="saveBtn" class="main-btn hidden">Poster ma sauce</button>
      </div>
    </div>
  </div>

  <script src="/static/js/async-recipe-generator.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "{{ supabase_url }}";
    const SUPABASE_ANON_KEY = "{{ supabase_anon_key }}";
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Check authentication
    client.auth.getSession().then(({ data: { session } }) => {
      if (!session) {
        window.location.href = '/';
      }
    });

    let currentRecipe = null;
    let asyncRecipeGenerator = null;

    // Initialize the async recipe generator when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      asyncRecipeGenerator = new AsyncRecipeGenerator();
    });

    function displayRecipe(data) {
      const recipeDiv = document.getElementById('recipe');
      
      if (!data.is_recipe) {
        recipeDiv.innerHTML = `
          <div class="recipe-section error-message">
            <p>Désolé, je ne peux pas créer une recette à partir de ce texte. Pourriez-vous me donner plus de détails sur la recette que vous souhaitez ?</p>
          </div>
        `;
        recipeDiv.classList.add('visible');
        
        // Reset the text input
        document.getElementById('prompt').value = '';
        document.getElementById('initial-input').classList.remove('hidden');
        document.getElementById('update-input').classList.add('hidden');
        generateBtn.disabled = false;
        generateBtn.textContent = 'Générer la recette';
        return;
      }

      // Only continue with recipe display and update form if it's a valid recipe
      document.getElementById('initial-input').classList.add('hidden');
      document.getElementById('update-input').classList.remove('hidden');

      recipeDiv.innerHTML = `
        <div class="recipe-section">
          <h2 style="color: #1976d2; margin-bottom: 24px; text-align: center;">${data.title || 'Recette'}</h2>
        </div>
        <div class="recipe-section">
          <h3>Ingrédients</h3>
          <ul class="recipe-list">
            ${data.ingredients.map(i => `<li>${i}</li>`).join('')}
          </ul>
        </div>
        <div class="recipe-section">
          <h3>Étapes</h3>
          <ul class="recipe-list">
            ${data.steps.map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>
        ${data.other_elements && data.other_elements.length > 0 ? `
          <div class="recipe-section">
            <h3>Eléments supplémentaires</h3>
            <ul class="other-elements-list">
              ${data.other_elements.map(q => `<li>${q}</li>`).join('')}
            </ul>
          </div>
        ` : ''}
      `;
      recipeDiv.classList.add('visible');
    }

    const prompt = document.getElementById('prompt');
    const generateBtn = document.getElementById('generateBtn');
    const updatePrompt = document.getElementById('update-prompt');
    const updateBtn = document.getElementById('updateBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Function to enable save button
    function showSaveButton() {
      saveBtn.classList.remove('hidden');
    }

    prompt.addEventListener('input', () => {
      generateBtn.disabled = !prompt.value.trim();
    });

    updatePrompt.addEventListener('input', () => {
      updateBtn.disabled = !updatePrompt.value.trim();
    });

    generateBtn.addEventListener('click', async () => {
      const text = prompt.value.trim();
      if (!text) return;

      generateBtn.disabled = true;
      generateBtn.textContent = 'Génération en cours...';

      try {
        const data = await asyncRecipeGenerator.generateFromText(text, (progress) => {
          // Update button text with progress feedback
          generateBtn.textContent = 'Génération en cours...';
        });

        currentRecipe = data;
        displayRecipe(data);

        // Show/hide appropriate inputs based on whether it's a recipe
        if (data.is_recipe) {
          document.getElementById('initial-input').style.display = 'none';
          document.getElementById('update-input').style.display = 'block';
          updatePrompt.value = '';
          showSaveButton(); // Show the save button when a recipe is generated
        }

      } catch (error) {
        alert('Erreur: ' + error.message);
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'Générer la recette';
      }
    });

    updateBtn.addEventListener('click', async () => {
      const text = updatePrompt.value.trim();
      if (!text || !currentRecipe) return;

      updateBtn.disabled = true;
      updateBtn.textContent = 'Modification en cours...';

      try {
        const data = await asyncRecipeGenerator.updateRecipe(currentRecipe, text, (progress) => {
          // Update button text with progress feedback
          updateBtn.textContent = 'Modification en cours...';
        });

        currentRecipe = data;
        displayRecipe(data);
        updatePrompt.value = '';
        showSaveButton(); // Show the save button after updating recipe

      } catch (error) {
        alert('Erreur: ' + error.message);
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = 'Modifier la recette';
      }
    });

    saveBtn.addEventListener('click', async () => {
      if (!currentRecipe) return;

      saveBtn.disabled = true;
      saveBtn.textContent = 'Sauvegarde en cours...';

      try {
        const recipeToSave = {
          title: currentRecipe.title,
          ingredients: currentRecipe.ingredients,
          steps: currentRecipe.steps,
          other_elements: currentRecipe.other_elements || [],
          origin: 'text_ia'
        };

        const response = await fetch('/save_recipe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(recipeToSave)
        });

        const data = await response.json();
        if (data.error) {
          throw new Error(data.error);
        }

        alert('Votre recette a été sauvegardée avec succès !');
        window.location.href = '/feed'; // Redirect to feed after successful save

      } catch (error) {
        alert('Erreur lors de la sauvegarde : ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Poster ma sauce';
      }
    });
  </script>
</body>
</html>
