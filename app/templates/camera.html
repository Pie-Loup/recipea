<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera - sauce</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style_camera.css') }}">
</head>
<body>
    <div class="camera-container">
        <!-- Bouton retour -->
        <button class="back-button" onclick="goBack()">â†</button>
        
        <!-- Loading spinner -->
        <div class="camera-loading" id="loadingSpinner">
            <div class="spinner"></div>
            Chargement de la camÃ©ra...
        </div>
        
        <!-- Message d'erreur -->
        <div class="camera-error" id="errorMessage" style="display: none;">
            <div>âŒ Impossible d'accÃ©der Ã  la camÃ©ra</div>
            <div>VÃ©rifiez les permissions de votre navigateur</div>
            <button onclick="retryCamera()">RÃ©essayer</button>
        </div>
        
        <!-- Flux vidÃ©o -->
        <video id="cameraStream" autoplay playsinline style="display: none;"></video>
        
        <!-- ContrÃ´les camÃ©ra -->
        <div class="camera-controls" id="cameraControls" style="display: none;">
            <button id="captureButton">ğŸ“¸</button>
        </div>
        
        <!-- Canvas cachÃ© pour la capture -->
        <canvas id="photoCanvas" style="display: none;"></canvas>
    </div>
    
    <!-- Modal de prÃ©visualisation photo -->
    <div class="photo-preview" id="photoPreview">
        <img id="capturedPhoto" src="" alt="Photo capturÃ©e">
        <div class="photo-actions">
            <button class="save-photo" onclick="savePhoto()">ğŸ’¾ Sauvegarder</button>
            <button class="retake-photo" onclick="retakePhoto()">ğŸ”„ Reprendre</button>
            <button class="cancel-photo" onclick="cancelPhoto()">âŒ Annuler</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('photoCanvas');
        const captureButton = document.getElementById('captureButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        const cameraControls = document.getElementById('cameraControls');
        const photoPreview = document.getElementById('photoPreview');
        const capturedPhoto = document.getElementById('capturedPhoto');
        
        let currentStream = null;
        let lastCapturedPhoto = null;

        // Retourner Ã  la page prÃ©cÃ©dente
        function goBack() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            window.history.back();
        }

        // DÃ©marrer la camÃ©ra
        async function startCamera() {
            try {
                loadingSpinner.style.display = 'block';
                errorMessage.style.display = 'none';
                
                // Contraintes pour la camÃ©ra
                const constraints = {
                    video: {
                        facingMode: 'environment', // CamÃ©ra arriÃ¨re par dÃ©faut
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Attendre que la vidÃ©o soit prÃªte
                video.onloadedmetadata = () => {
                    loadingSpinner.style.display = 'none';
                    video.style.display = 'block';
                    cameraControls.style.display = 'flex';
                };
                
            } catch (error) {
                console.error('Erreur d\'accÃ¨s Ã  la camÃ©ra:', error);
                loadingSpinner.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }

        // RÃ©essayer l'accÃ¨s Ã  la camÃ©ra
        function retryCamera() {
            startCamera();
        }

        // Capturer une photo
        function capturePhoto() {
            if (!video.videoWidth || !video.videoHeight) {
                alert('La camÃ©ra n\'est pas encore prÃªte. Veuillez patienter.');
                return;
            }
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            lastCapturedPhoto = canvas.toDataURL('image/jpeg', 0.9);
            capturedPhoto.src = lastCapturedPhoto;
            photoPreview.style.display = 'flex';
        }

        // Reprendre une photo
        function retakePhoto() {
            photoPreview.style.display = 'none';
            lastCapturedPhoto = null;
        }

        // Annuler la photo
        function cancelPhoto() {
            photoPreview.style.display = 'none';
            lastCapturedPhoto = null;
        }

        // Sauvegarder la photo
        function savePhoto() {
            if (lastCapturedPhoto) {
                // CrÃ©er un lien de tÃ©lÃ©chargement
                const link = document.createElement('a');
                link.download = `sauce-photo-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.jpg`;
                link.href = lastCapturedPhoto;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Fermer la prÃ©visualisation
                cancelPhoto();
                
                // Optionnel: rediriger vers le feed aprÃ¨s sauvegarde
                setTimeout(() => {
                    window.location.href = '/feed';
                }, 500);
            }
        }

        // Event listeners
        captureButton.addEventListener('click', capturePhoto);

        // Gestion des touches du clavier
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' || event.code === 'Enter') {
                event.preventDefault();
                if (photoPreview.style.display === 'none' || !photoPreview.style.display) {
                    capturePhoto();
                }
            } else if (event.code === 'Escape') {
                if (photoPreview.style.display === 'flex') {
                    cancelPhoto();
                } else {
                    goBack();
                }
            }
        });

        // Nettoyer les ressources avant de quitter la page
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

        // DÃ©marrer la camÃ©ra au chargement de la page
        window.addEventListener('load', startCamera);
        
        // Gestion de l'orientation sur mobile
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (video.videoWidth && video.videoHeight) {
                    // RÃ©ajuster si nÃ©cessaire
                }
            }, 500);
        });
    </script>
</body>
</html>
